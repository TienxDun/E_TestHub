@model E_TestHub.Models.TakeExamViewModel
@{
    ViewData["Title"] = "Làm bài thi - Sinh Viên";
    Layout = "~/Views/Shared/_ExamLayout.cshtml";
}

@section Styles {
    <link href="~/css/student/take-exam.css" rel="stylesheet">
    <style>
        .auto-save-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 10px 15px;
            background: #27ae60;
            color: white;
            border-radius: 4px;
            display: none;
            z-index: 1000;
            animation: fadeInOut 2s;
        }
        @@keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        .exam-disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        .message-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
}

@if (!Model.CanStart)
{
    <div class="exam-container">
        <div class="message-box">
            <h2>@Model.Message</h2>
            <a href="@Url.Action("MyExams")" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>
}
else
{
    <div class="exam-container" id="examContainer">
        <!-- Auto-save indicator -->
        <div class="auto-save-indicator" id="autoSaveIndicator">
            <i class="fas fa-check"></i> Đã lưu tự động
        </div>

        <!-- Toggle Button for Mobile -->
        <button class="question-nav-toggle" id="questionNavToggle" onclick="toggleQuestionNav()">
            <i class="fas fa-list"></i>
            <span>Danh sách câu hỏi</span>
        </button>

        <!-- Left Sidebar - Question Navigation -->
        <div class="question-nav-sidebar" id="questionNavSidebar">
            <div class="nav-header">
                <div class="nav-title">Danh sách câu hỏi</div>
                <div class="nav-subtitle">Đã hoàn thành: <span id="completedCount">0</span>/@Model.Questions.Count câu hỏi</div>
                <button class="nav-close-btn" onclick="toggleQuestionNav()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="question-grid" id="questionGrid">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    <div class="question-number @(i == 0 ? "current" : "")" onclick="goToQuestion(@(i + 1))">@(i + 1)</div>
                }
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="exam-main-content">
            <!-- Exam Header -->
            <div class="exam-header">
                <div class="exam-info">
                    <a href="@Url.Action("ExamInfo", "Student", new { examId = Model.Exam.ApiId })" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại
                    </a>
                    <h1 class="exam-title">@Model.Exam.Title</h1>
                </div>
                
                <div class="exam-controls">
                    <div class="timer">
                        <i class="fas fa-clock"></i>
                        <span id="timeRemaining">@(Model.DurationMinutes):00</span>
                    </div>
                    <button class="submit-btn" onclick="submitExam()">
                        <i class="fas fa-paper-plane"></i>
                        Nộp bài
                    </button>
                </div>
            </div>
            
            <!-- Question Content -->
            <div class="question-content">
                <div class="question-header">
                    <h2 class="question-title">Câu <span id="currentQuestionNumber">1</span></h2>
                </div>
                
                <div id="questionContainer">
                    @for (int i = 0; i < Model.Questions.Count; i++)
                    {
                        var question = Model.Questions[i];
                        <div class="question" id="question@(i + 1)" style="display: @(i == 0 ? "block" : "none");" data-question-id="@question.ApiId">
                            <div class="question-text">
                                @Html.Raw(question.Content)
                            </div>
                            
                            @if (question.Type == E_TestHub.Models.QuestionType.MultipleChoice)
                            {
                                <ul class="answer-options">
                                    @for (int j = 0; j < question.Options.Count && j < 4; j++)
                                    {
                                        var optionLabel = ((char)('A' + j)).ToString();
                                        var option = question.Options[j];
                                        @if (!string.IsNullOrEmpty(option))
                                        {
                                            <li class="answer-option">
                                                <label>
                                                    <input type="radio" name="question@(i + 1)" value="@optionLabel" data-question-id="@question.ApiId">
                                                    <span class="answer-text">@option</span>
                                                </label>
                                            </li>
                                        }
                                    }
                                </ul>
                            }
                            else if (question.Type == E_TestHub.Models.QuestionType.TrueFalse)
                            {
                                <ul class="answer-options">
                                    <li class="answer-option">
                                        <label>
                                            <input type="radio" name="question@(i + 1)" value="True" data-question-id="@question.ApiId">
                                            <span class="answer-text">Đúng</span>
                                        </label>
                                    </li>
                                    <li class="answer-option">
                                        <label>
                                            <input type="radio" name="question@(i + 1)" value="False" data-question-id="@question.ApiId">
                                            <span class="answer-text">Sai</span>
                                        </label>
                                    </li>
                                </ul>
                            }
                            else if (question.Type == E_TestHub.Models.QuestionType.Essay)
                            {
                                <textarea 
                                    class="form-control essay-answer" 
                                    name="question@(i + 1)" 
                                    rows="6" 
                                    placeholder="Nhập câu trả lời của bạn..."
                                    data-question-id="@question.ApiId"></textarea>
                            }
                        </div>
                    }
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="question-navigation">
                <button class="nav-btn" id="prevBtn" onclick="previousQuestion()">
                    <i class="fas fa-chevron-left"></i>
                    Câu trước
                </button>
                <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">
                    Câu sau
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let currentQuestionIndex = 1;
        const totalQuestions = @Model.Questions.Count;
        let submissionId = '@Model.ExistingSubmission?.ApiId';
        const examId = '@(Model.Exam.ApiId ?? Context.Request.Query["examId"].ToString())';
        const examDuration = @Model.DurationMinutes; // minutes
        let autoSaveInterval;
        let timerInterval;
        let timeRemaining = examDuration * 60; // seconds
        let hasStarted = false;
        
        // Debug log
        console.log('Exam ID:', examId);
        if (!examId || examId === '') {
            console.error('CRITICAL: examId is empty!');
            alert('Lỗi: Không tìm thấy mã đề thi. Vui lòng quay lại và thử lại.');
        }

        // Start exam on page load
        $(document).ready(async function() {
            if (!submissionId) {
                await startExam();
            } else {
                hasStarted = true;
                loadExistingAnswers();
            }
            
            if (hasStarted) {
                startTimer();
                startAutoSave();
            }

            // Add change listeners
            $('input[type="radio"], textarea.essay-answer').on('change', function() {
                updateCompletedCount();
                markQuestionAsAnswered(currentQuestionIndex);
            });
        });

        // Start exam - create submission
        async function startExam() {
            try {
                const response = await fetch('@Url.Action("StartExam")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ examId: examId })
                });

                const data = await response.json();
                
                if (data.success) {
                    submissionId = data.submissionId;
                    hasStarted = true;
                    console.log('Exam started. Submission ID:', submissionId);
                } else {
                    alert('Không thể bắt đầu làm bài: ' + data.message);
                    window.location.href = '@Url.Action("MyExams")';
                }
            } catch (error) {
                console.error('Error starting exam:', error);
                alert('Lỗi khi bắt đầu làm bài');
            }
        }

        // Load existing answers (if resuming)
        function loadExistingAnswers() {
            @if (Model.ExistingSubmission?.Answers != null && Model.ExistingSubmission.Answers.Any())
            {
                <text>
                const existingAnswers = @Html.Raw(Json.Serialize(Model.ExistingSubmission.Answers));
                
                existingAnswers.forEach(answer => {
                    const input = $(`[data-question-id="${answer.questionId}"][value="${answer.selectedOption}"]`);
                    if (input.length > 0) {
                        input.prop('checked', true);
                    }
                });
                
                updateCompletedCount();
                updateAllQuestionStatus();
                </text>
            }
        }

        // Auto-save functionality
        function startAutoSave() {
            autoSaveInterval = setInterval(async () => {
                await saveAnswers();
            }, 30000); // Save every 30 seconds
        }

        async function saveAnswers() {
            if (!submissionId) return;

            const answers = collectAnswers();
            
            try {
                const response = await fetch('@Url.Action("SaveAnswers")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        submissionId: submissionId,
                        answers: answers
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAutoSaveIndicator();
                    console.log('Auto-saved successfully');
                }
            } catch (error) {
                console.error('Error auto-saving:', error);
            }
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // Collect all answers
        function collectAnswers() {
            const answers = [];
            
            for (let i = 1; i <= totalQuestions; i++) {
                const questionDiv = $(`#question${i}`);
                const questionId = questionDiv.data('question-id');
                const selectedInput = $(`input[name="question${i}"]:checked, textarea[name="question${i}"]`);
                
                if (selectedInput.length > 0) {
                    answers.push({
                        questionId: questionId,
                        selectedOption: selectedInput.val(),
                        score: 0 // Will be calculated on server
                    });
                }
            }
            
            return answers;
        }

        // Submit exam
        async function submitExam() {
            if (!confirm('Bạn có chắc chắn muốn nộp bài? Bạn sẽ không thể sửa đổi sau khi nộp.')) {
                return;
            }

            const answers = collectAnswers();
            
            if (answers.length < totalQuestions) {
                if (!confirm(`Bạn mới trả lời ${answers.length}/${totalQuestions} câu hỏi. Bạn có muốn nộp bài không?`)) {
                    return;
                }
            }

            try {
                // Stop auto-save and timer
                clearInterval(autoSaveInterval);
                clearInterval(timerInterval);

                const response = await fetch('@Url.Action("SubmitExam")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        submissionId: submissionId,
                        answers: answers
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    window.location.href = data.redirectUrl;
                } else {
                    alert('Không thể nộp bài: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting exam:', error);
                alert('Lỗi khi nộp bài');
            }
        }

        // Timer functionality
        function startTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = display;
            
            // Warning at 5 minutes
            if (timeRemaining === 300) {
                alert('⚠️ Còn 5 phút để hoàn thành bài thi!');
            }
        }

        async function autoSubmitExam() {
            alert('⏰ Hết giờ làm bài! Bài thi sẽ được tự động nộp.');
            await submitExam();
        }

        // Question navigation
        function goToQuestion(questionNumber) {
            if (questionNumber < 1 || questionNumber > totalQuestions) return;
            
            currentQuestionIndex = questionNumber;
            updateQuestionUI();
        }

        function nextQuestion() {
            if (currentQuestionIndex < totalQuestions) {
                currentQuestionIndex++;
                updateQuestionUI();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 1) {
                currentQuestionIndex--;
                updateQuestionUI();
            }
        }

        function updateQuestionUI() {
            // Hide all questions
            document.querySelectorAll('.question').forEach(q => q.style.display = 'none');
            
            // Show current question
            document.getElementById(`question${currentQuestionIndex}`).style.display = 'block';
            
            // Update question number display
            document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 1;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === totalQuestions;
            
            // Update question grid
            document.querySelectorAll('.question-number').forEach((btn, index) => {
                btn.classList.toggle('current', index + 1 === currentQuestionIndex);
            });
        }

        function updateCompletedCount() {
            let completed = 0;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked, textarea[name="question${i}"]`);
                if (selected && selected.value) {
                    completed++;
                }
            }
            
            document.getElementById('completedCount').textContent = completed;
        }

        function updateAllQuestionStatus() {
            for (let i = 1; i <= totalQuestions; i++) {
                markQuestionAsAnswered(i);
            }
        }

        function markQuestionAsAnswered(questionNumber) {
            const selected = document.querySelector(`input[name="question${questionNumber}"]:checked, textarea[name="question${questionNumber}"]`);
            const btn = document.querySelectorAll('.question-number')[questionNumber - 1];
            
            if (selected && selected.value) {
                btn.classList.add('answered');
            } else {
                btn.classList.remove('answered');
            }
        }

        // Toggle sidebar (mobile)
        function toggleQuestionNav() {
            const sidebar = document.getElementById('questionNavSidebar');
            sidebar.classList.toggle('active');
        }

        // Prevent accidental page leave
        window.addEventListener('beforeunload', function(e) {
            if (hasStarted) {
                e.preventDefault();
                e.returnValue = 'Bạn có chắc chắn muốn rời khỏi? Tiến trình làm bài sẽ được lưu tự động.';
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') previousQuestion();
            else if (e.key === 'ArrowRight') nextQuestion();
        });
    </script>
    @Html.AntiForgeryToken()
}
