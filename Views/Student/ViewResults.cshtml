@{
    ViewData["Title"] = "Kết quả bài thi - Sinh Viên";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    
    var examInfo = ViewBag.ExamInfo;
    var timeSpent = ViewBag.TimeSpent;
    var accuracy = ViewBag.Accuracy;
    var questions = (List<E_TestHub.Models.Question>)ViewBag.Questions ?? new List<E_TestHub.Models.Question>();
    var answers = (List<E_TestHub.Models.SubmissionAnswer>)ViewBag.Answers ?? new List<E_TestHub.Models.SubmissionAnswer>();
    
    // Create a dictionary for quick lookup of user answers by questionId (using ApiId)
    var answerDict = new Dictionary<string, E_TestHub.Models.SubmissionAnswer>();
    foreach (var answer in answers)
    {
        if (!string.IsNullOrEmpty(answer.QuestionId))
        {
            answerDict[answer.QuestionId] = answer;
        }
    }
}

@section Styles {
    <link href="~/css/shared/dashboard.css" rel="stylesheet">
    <link href="~/css/student/view-results.css" rel="stylesheet">
}

<div class="exam-results-container">
    <!-- Left Sidebar - Question List & Info -->
    <div class="questions-sidebar">
        <!-- Student Info Section -->
        <div>
            <div class="student-info-card">
                <div class="student-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="student-details">
                    <div class="student-name">@ViewBag.UserName</div>
                    <div class="student-id">Kết quả của bạn</div>
                </div>
            </div>
        </div>

        <!-- Exam Details Section -->
        <div class="exam-details-section">
            <h4 class="section-title">
                <i class="fas fa-info-circle"></i>
                Thông tin bài thi
            </h4>
            
            <div class="info-row">
                <span class="info-label">
                    <i class="fas fa-calendar-alt"></i>
                    Ngày thi:
                </span>
                <span class="info-value">@examInfo.ExamDate.ToString("dd/MM/yyyy HH:mm")</span>
            </div>
            
            <div class="info-row">
                <span class="info-label">
                    <i class="fas fa-clock"></i>
                    Thời gian nộp:
                </span>
                <span class="info-value">@examInfo.SubmittedAt.ToString("dd/MM/yyyy HH:mm")</span>
            </div>
            
            <div class="info-row">
                <span class="info-label">
                    <i class="fas fa-hourglass-half"></i>
                    Thời gian làm bài:
                </span>
                <span class="info-value">@timeSpent phút</span>
            </div>
            
            <div class="info-row highlight">
                <span class="info-label">
                    <i class="fas fa-chart-line"></i>
                    Độ chính xác:
                </span>
                <span class="info-value accuracy">@accuracy%</span>
            </div>
            
            <div class="info-row highlight">
                <span class="info-label">
                    <i class="fas fa-star"></i>
                    Điểm số:
                </span>
                <span class="info-value score">@examInfo.Score/@examInfo.MaxScore</span>
            </div>
        </div>
        
        <!-- Question Statistics -->
        <div class="question-stats">
            <div class="stat-row">
                <span class="stat-label">Tổng số câu:</span>
                <span class="stat-value">@examInfo.TotalQuestions</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Đúng:</span>
                <span class="stat-value correct">@examInfo.CorrectAnswers</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Sai:</span>
                <span class="stat-value incorrect">@examInfo.IncorrectAnswers</span>
            </div>
        </div>
        
        <!-- Dynamic Question Grid -->
        <div class="question-grid" id="questionGrid">
            @for (int i = 0; i < questions.Count; i++)
            {
                var questionNum = i + 1;
                var question = questions[i];
                var questionApiId = question.ApiId ?? question.Id.ToString();
                var hasAnswer = answerDict.ContainsKey(questionApiId);
                var isCorrect = hasAnswer && answerDict[questionApiId].Score > 0;
                var cssClass = isCorrect ? "correct" : "incorrect";
                
                <div class="question-number @cssClass" data-question="@questionNum" onclick="showQuestion(@questionNum)">@questionNum</div>
            }
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="exam-main-content">
        <!-- Header -->
        <div class="exam-header">
            <div class="header-left">
                <a href="@Url.Action("MyExams", "Student")" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại
                </a>
                <h2 class="exam-title">@examInfo.Name - @examInfo.Subject</h2>
            </div>
        </div>

        <!-- Question Content -->
        <div class="question-content">
            <div id="questionContainer">
                @for (int i = 0; i < questions.Count; i++)
                {
                    var questionNum = i + 1;
                    var question = questions[i];
                    var questionApiId = question.ApiId ?? question.Id.ToString();
                    var hasAnswer = answerDict.ContainsKey(questionApiId);
                    var userAnswer = hasAnswer ? answerDict[questionApiId].SelectedOption : "";
                    var isCorrect = hasAnswer && answerDict[questionApiId].Score > 0;
                    var displayStyle = questionNum == 1 ? "block" : "none";
                    
                    <div class="question-block" id="question@questionNum" style="display: @displayStyle;">
                        <div class="question-header">
                            <h3 class="question-title">Câu @questionNum</h3>
                            <p class="question-text">@question.Content</p>
                        </div>
                        
                        <ul class="answer-options">
                            @for (int optIndex = 0; optIndex < question.Options.Count; optIndex++)
                            {
                                var optionLetter = ((char)('A' + optIndex)).ToString();
                                var optionText = question.Options[optIndex];
                                var isUserSelected = userAnswer == optionLetter;
                                var isCorrectAnswer = question.CorrectAnswer == optionLetter;
                                
                                var optionClass = "";
                                var statusLabel = "";
                                
                                if (isUserSelected && isCorrectAnswer)
                                {
                                    // User selected correct answer
                                    optionClass = "user-selected correct";
                                    statusLabel = "Đúng";
                                }
                                else if (isUserSelected && !isCorrectAnswer)
                                {
                                    // User selected wrong answer
                                    optionClass = "user-selected incorrect";
                                    statusLabel = "Bạn chọn";
                                }
                                else if (!isUserSelected && isCorrectAnswer)
                                {
                                    // Correct answer not selected by user
                                    optionClass = "correct";
                                    statusLabel = "Đáp án đúng";
                                }
                                
                                <li class="answer-option @optionClass">
                                    <label>
                                        <input type="radio" name="q@questionNum" value="@optionLetter" disabled @(isUserSelected ? "checked" : "")>
                                        <span class="answer-text">@optionText</span>
                                        @if (!string.IsNullOrEmpty(statusLabel))
                                        {
                                            <span class="answer-status @(isCorrectAnswer ? "correct" : "incorrect")">@statusLabel</span>
                                        }
                                    </label>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>

        <!-- Navigation -->
        <div class="question-navigation">
            <button id="prevBtn" onclick="previousQuestion()" class="nav-btn prev-btn">
                <i class="fas fa-chevron-left"></i>
                Câu trước
            </button>
            
            <span class="question-counter">
                Câu <span id="currentQuestionNum">1</span> / @questions.Count
            </span>
            
            <button id="nextBtn" onclick="nextQuestion()" class="nav-btn next-btn">
                Câu sau
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentQuestionIndex = 1;
        const totalQuestions = @questions.Count;

        function showQuestion(questionNum) {
            // Hide all questions
            for (let i = 1; i <= totalQuestions; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionElement) {
                    questionElement.style.display = 'none';
                }
            }

            // Show selected question
            const selectedQuestion = document.getElementById(`question${questionNum}`);
            if (selectedQuestion) {
                selectedQuestion.style.display = 'block';
            } else {
                console.log(`Question ${questionNum} not found`);
            }

            // Update current question index
            currentQuestionIndex = questionNum;

            // Update navigation buttons
            updateNavigationButtons();

            // Update question counter
            document.getElementById('currentQuestionNum').textContent = questionNum;

            // Update question number highlighting
            updateQuestionHighlight();
        }

        function updateQuestionHighlight() {
            // Remove current class from all question numbers
            document.querySelectorAll('.question-number').forEach(element => {
                element.classList.remove('current');
            });

            // Add current class to selected question using data-question attribute
            const currentElement = document.querySelector(`.question-number[data-question="${currentQuestionIndex}"]`);
            if (currentElement) {
                currentElement.classList.add('current');
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentQuestionIndex === 1;
            nextBtn.disabled = currentQuestionIndex === totalQuestions;
        }

        function previousQuestion() {
            if (currentQuestionIndex > 1) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < totalQuestions) {
                showQuestion(currentQuestionIndex + 1);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showQuestion(1);
        });
    </script>
}
