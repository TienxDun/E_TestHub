@{
    ViewData["Title"] = "Ng√¢n h√†ng c√¢u h·ªèi";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

@section Styles {
    <link href="~/css/shared/dashboard.css" rel="stylesheet">
    <link href="~/css/teacher/question-bank.css" rel="stylesheet">
}

<!-- Welcome Section -->
<div class="dashboard-welcome-section">
    <h1 class="dashboard-welcome-title" style="font-weight: 700; color: #1a73e8;">Ng√¢n h√†ng c√¢u h·ªèi</h1>
    <p class="dashboard-welcome-subtitle">Qu·∫£n l√Ω v√† t·ªï ch·ª©c kho c√¢u h·ªèi tr·∫Øc nghi·ªám</p>
</div>

<!-- Action Cards -->
<div class="dashboard-action-cards">
    <a href="#" class="dashboard-action-card" onclick="openAddQuestionModal(); return false;">
        <div class="dashboard-action-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <h3 class="dashboard-action-title">Th√™m c√¢u h·ªèi</h3>
        <p class="dashboard-action-subtitle">T·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám m·ªõi</p>
    </a>

    <a href="#" class="dashboard-action-card" onclick="alert('T√≠nh nƒÉng Import ƒëang ph√°t tri·ªÉn'); return false;">
        <div class="dashboard-action-icon">
            <i class="fas fa-file-import"></i>
        </div>
        <h3 class="dashboard-action-title">Import c√¢u h·ªèi</h3>
        <p class="dashboard-action-subtitle">Nh·∫≠p t·ª´ file Excel/CSV</p>
    </a>

    <a href="#" class="dashboard-action-card" onclick="alert('T√≠nh nƒÉng Export ƒëang ph√°t tri·ªÉn'); return false;">
        <div class="dashboard-action-icon">
            <i class="fas fa-file-export"></i>
        </div>
        <h3 class="dashboard-action-title">Export c√¢u h·ªèi</h3>
        <p class="dashboard-action-subtitle">Xu·∫•t ra file Excel/PDF</p>
    </a>
</div>

<!-- Content Sections -->
<div class="dashboard-content-sections">
    <!-- Statistics Section - Modern & Simplified -->
    <div class="dashboard-section">
        <div class="dashboard-section-header">
            <h3 class="dashboard-section-title">
                <i class="fas fa-chart-bar" style="margin-right: 8px; color: #1a73e8;"></i>
                Th·ªëng k√™ t·ªïng quan
            </h3>
        </div>

        <div class="stats-grid-modern">
            <!-- Total Questions -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-primary">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">145</div>
                    <div class="stat-label-modern">T·ªïng c√¢u h·ªèi</div>
                </div>
            </div>

            <!-- Total Subjects -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-success">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">4</div>
                    <div class="stat-label-modern">M√¥n h·ªçc</div>
                </div>
            </div>

            <!-- Weekly Added -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">12</div>
                    <div class="stat-label-modern">Th√™m tu·∫ßn n√†y</div>
                </div>
            </div>

            <!-- Usage Rate -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-info">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">89%</div>
                    <div class="stat-label-modern">T·ª∑ l·ªá s·ª≠ d·ª•ng</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions by Subject Section -->
    <div class="dashboard-section">
        <div class="dashboard-section-header">
            <h3 class="dashboard-section-title">Ph√¢n b·ªï theo m√¥n h·ªçc</h3>
        </div>

        <div class="subject-distribution">
            <div class="subject-bar-item">
                <div class="subject-bar-info">
                    <span class="subject-name">X√°c su·∫•t th·ªëng k√™</span>
                    <span class="subject-count">60 c√¢u h·ªèi</span>
                </div>
                <div class="subject-bar-progress">
                    <div class="subject-bar-fill" style="width: 41%"></div>
                </div>
            </div>

            <div class="subject-bar-item">
                <div class="subject-bar-info">
                    <span class="subject-name">ƒê·∫°i s·ªë tuy·∫øn t√≠nh</span>
                    <span class="subject-count">40 c√¢u h·ªèi</span>
                </div>
                <div class="subject-bar-progress">
                    <div class="subject-bar-fill" style="width: 28%"></div>
                </div>
            </div>

            <div class="subject-bar-item">
                <div class="subject-bar-info">
                    <span class="subject-name">Gi·∫£i t√≠ch 1</span>
                    <span class="subject-count">30 c√¢u h·ªèi</span>
                </div>
                <div class="subject-bar-progress">
                    <div class="subject-bar-fill" style="width: 21%"></div>
                </div>
            </div>

            <div class="subject-bar-item">
                <div class="subject-bar-info">
                    <span class="subject-name">To√°n r·ªùi r·∫°c</span>
                    <span class="subject-count">15 c√¢u h·ªèi</span>
                </div>
                <div class="subject-bar-progress">
                    <div class="subject-bar-fill" style="width: 10%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Questions Section with Tabs & Pagination -->
<div id="all-questions" class="dashboard-section" style="margin-top: 50px;">
    <div class="dashboard-section-header">
        <h3 class="dashboard-section-title">Danh s√°ch c√¢u h·ªèi</h3>
    </div>

    <!-- Subject Filter Section - Modern Chip Design -->
    <div class="subject-filter-section">
        <div class="subject-chips">
            <button class="subject-chip active" data-subject="all" onclick="switchSubjectTab('all')">
                <span class="chip-label">T·∫•t c·∫£</span>
                <span class="chip-badge">145</span>
            </button>
            <button class="subject-chip" data-subject="xstk" onclick="switchSubjectTab('xstk')">
                <span class="chip-label">X√°c su·∫•t th·ªëng k√™</span>
                <span class="chip-badge">60</span>
            </button>
            <button class="subject-chip" data-subject="dstt" onclick="switchSubjectTab('dstt')">
                <span class="chip-label">ƒê·∫°i s·ªë tuy·∫øn t√≠nh</span>
                <span class="chip-badge">40</span>
            </button>
            <button class="subject-chip" data-subject="giai-tich" onclick="switchSubjectTab('giai-tich')">
                <span class="chip-label">Gi·∫£i t√≠ch 1</span>
                <span class="chip-badge">30</span>
            </button>
            <button class="subject-chip" data-subject="toan-roi-rac" onclick="switchSubjectTab('toan-roi-rac')">
                <span class="chip-label">To√°n r·ªùi r·∫°c</span>
                <span class="chip-badge">15</span>
            </button>
        </div>

        <div class="filter-actions">
            <select id="itemsPerPage" class="per-page-select" onchange="changeItemsPerPage()">
                <option value="10" selected>10 / trang</option>
                <option value="20">20 / trang</option>
                <option value="50">50 / trang</option>
            </select>
        </div>
    </div>

    <!-- Questions List Container -->
    <div id="questionListContainer" class="question-list-container">
        <!-- Questions will be dynamically loaded here -->
    </div>

    <!-- Pagination Footer -->
    <div class="pagination-footer">
        <div class="pagination-info">
            Hi·ªÉn th·ªã <span id="showingFrom">1</span>-<span id="showingTo">10</span> trong <span id="totalQuestions">145</span> c√¢u h·ªèi
        </div>
        <div class="pagination-buttons" id="paginationButtons">
            <!-- Pagination buttons will be generated here -->
        </div>
    </div>

    <!-- Empty State (when no questions) -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-inbox"></i>
        <h3>Ch∆∞a c√≥ c√¢u h·ªèi n√†o</h3>
        <p>Nh·∫•n n√∫t "Th√™m c√¢u h·ªèi" ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o c√¢u h·ªèi cho m√¥n h·ªçc n√†y</p>
    </div>
</div>

<!-- Add Question Modal -->
<div id="addQuestionModal" class="question-modal" style="display: none;">
    <div class="question-modal-content question-modal-content-large">
        <div class="question-modal-header">
            <h3><i class="fas fa-plus-circle"></i> Th√™m c√¢u h·ªèi</h3>
            <button onclick="closeAddQuestionModal()" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="question-modal-body">
            <!-- Batch Mode Container -->
            <div id="batchModeContainer">
                <!-- Batch Controls -->
                <div class="batch-controls">
                    <div class="batch-info">
                        <i class="fas fa-layer-group"></i>
                        <span>ƒê√£ th√™m <strong id="batchCount">0</strong> c√¢u h·ªèi</span>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addNewQuestionToBatch()">
                        <i class="fas fa-plus"></i> Th√™m c√¢u h·ªèi ti·∫øp
                    </button>
                </div>

                <!-- Batch Questions List -->
                <div id="batchQuestionsList" class="batch-questions-list">
                    <!-- Questions will be added here -->
                </div>

                <!-- Current Question Form (for batch) -->
                <div id="batchCurrentForm" class="batch-current-form">
                    <div class="batch-form-header">
                        <h4><i class="fas fa-edit"></i> C√¢u h·ªèi s·ªë <span id="currentBatchNumber">1</span></h4>
                    </div>

                    <form id="batchQuestionForm" onsubmit="addQuestionToBatch(event)">
                        <!-- Subject Selection -->
                        <div class="form-group">
                            <label for="batchQuestionSubject" class="form-label">
                                <i class="fas fa-book"></i> M√¥n h·ªçc <span class="required">*</span>
                            </label>
                            <select id="batchQuestionSubject" class="form-control" required>
                                <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                                <option value="xstk">X√°c su·∫•t th·ªëng k√™</option>
                                <option value="dstt">ƒê·∫°i s·ªë tuy·∫øn t√≠nh</option>
                                <option value="giai-tich">Gi·∫£i t√≠ch 1</option>
                                <option value="toan-roi-rac">To√°n r·ªùi r·∫°c</option>
                            </select>
                        </div>

                        <!-- Question Content -->
                        <div class="form-group">
                            <label for="batchQuestionContent" class="form-label">
                                <i class="fas fa-question-circle"></i> N·ªôi dung c√¢u h·ªèi <span class="required">*</span>
                            </label>
                            <textarea 
                                id="batchQuestionContent" 
                                class="form-control" 
                                rows="3" 
                                placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..."
                                required
                            ></textarea>
                        </div>

                        <!-- Options -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-list"></i> C√°c ƒë√°p √°n <span class="required">*</span>
                            </label>
                            
                            <!-- Option A -->
                            <div class="option-input-group">
                                <div class="option-radio">
                                    <input type="radio" id="batchCorrectA" name="batchCorrectAnswer" value="A">
                                    <label for="batchCorrectA" class="radio-label">
                                        <i class="fas fa-check-circle"></i>
                                    </label>
                                </div>
                                <div class="option-input">
                                    <span class="option-label">A.</span>
                                    <input type="text" id="batchOptionA" class="form-control-inline" placeholder="ƒê√°p √°n A" required>
                                </div>
                            </div>

                            <!-- Option B -->
                            <div class="option-input-group">
                                <div class="option-radio">
                                    <input type="radio" id="batchCorrectB" name="batchCorrectAnswer" value="B">
                                    <label for="batchCorrectB" class="radio-label">
                                        <i class="fas fa-check-circle"></i>
                                    </label>
                                </div>
                                <div class="option-input">
                                    <span class="option-label">B.</span>
                                    <input type="text" id="batchOptionB" class="form-control-inline" placeholder="ƒê√°p √°n B" required>
                                </div>
                            </div>

                            <!-- Option C -->
                            <div class="option-input-group">
                                <div class="option-radio">
                                    <input type="radio" id="batchCorrectC" name="batchCorrectAnswer" value="C">
                                    <label for="batchCorrectC" class="radio-label">
                                        <i class="fas fa-check-circle"></i>
                                    </label>
                                </div>
                                <div class="option-input">
                                    <span class="option-label">C.</span>
                                    <input type="text" id="batchOptionC" class="form-control-inline" placeholder="ƒê√°p √°n C" required>
                                </div>
                            </div>

                            <!-- Option D -->
                            <div class="option-input-group">
                                <div class="option-radio">
                                    <input type="radio" id="batchCorrectD" name="batchCorrectAnswer" value="D">
                                    <label for="batchCorrectD" class="radio-label">
                                        <i class="fas fa-check-circle"></i>
                                    </label>
                                </div>
                                <div class="option-input">
                                    <span class="option-label">D.</span>
                                    <input type="text" id="batchOptionD" class="form-control-inline" placeholder="ƒê√°p √°n D" required>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check"></i> Th√™m v√†o danh s√°ch
                            </button>
                            <button type="button" class="btn btn-outline" onclick="resetBatchForm()">
                                <i class="fas fa-redo"></i> L√†m m·ªõi
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Batch Save Actions -->
                <div class="batch-save-actions" id="batchSaveActions" style="display: none;">
                    <button type="button" class="btn btn-outline" onclick="clearBatch()">
                        <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveAllBatchQuestions()">
                        <i class="fas fa-save"></i> L∆∞u t·∫•t c·∫£ (<span id="batchSaveCount">0</span> c√¢u)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Batch mode state
        let batchQuestions = [];

        // Modal functions
        function openAddQuestionModal() {
            document.getElementById('addQuestionModal').style.display = 'flex';
            clearBatch(); // Reset batch state when opening modal
            updateBatchCount();
            console.log('‚úÖ Modal opened');
        }

        function closeAddQuestionModal() {
            // Warn if there are unsaved questions
            if (batchQuestions.length > 0) {
                if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ${batchQuestions.length} c√¢u h·ªèi ch∆∞a l∆∞u!\n\nƒê√≥ng modal s·∫Ω m·∫•t to√†n b·ªô d·ªØ li·ªáu. B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng?`)) {
                    console.log('‚ö†Ô∏è User cancelled close action');
                    return;
                }
            }
            
            document.getElementById('addQuestionModal').style.display = 'none';
            clearBatch();
            console.log('‚úÖ Modal closed');
        }

        // Reset batch form
        function resetBatchForm() {
            document.getElementById('batchQuestionForm').reset();
        }

        // Add question to batch
        function addQuestionToBatch(event) {
            event.preventDefault();
            
            try {
                console.log('üîµ Starting addQuestionToBatch...');
                
                const subject = document.getElementById('batchQuestionSubject');
                const content = document.getElementById('batchQuestionContent').value.trim();
                const optionA = document.getElementById('batchOptionA').value.trim();
                const optionB = document.getElementById('batchOptionB').value.trim();
                const optionC = document.getElementById('batchOptionC').value.trim();
                const optionD = document.getElementById('batchOptionD').value.trim();
                const correctAnswer = document.querySelector('input[name="batchCorrectAnswer"]:checked');

                console.log('üìù Form data:', { 
                    subject: subject?.value, 
                    content, 
                    optionA, 
                    optionB, 
                    optionC, 
                    optionD, 
                    correctAnswer: correctAnswer?.value 
                });

                // Validation
                if (!subject.value) {
                    alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn m√¥n h·ªçc!');
                    subject.focus();
                    return;
                }
                
                if (!content) {
                    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung c√¢u h·ªèi!');
                    document.getElementById('batchQuestionContent').focus();
                    return;
                }
                
                if (!optionA || !optionB || !optionC || !optionD) {
                    alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß 4 ƒë√°p √°n!');
                    return;
                }
                
                if (!correctAnswer) {
                    alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë√°p √°n ƒë√∫ng (click v√†o icon ‚úì)!');
                    return;
                }

                // Create question object
                const question = {
                    id: Date.now(),
                    subject: subject.value,
                    subjectName: subject.options[subject.selectedIndex].text,
                    title: content,
                    options: {
                        A: optionA,
                        B: optionB,
                        C: optionC,
                        D: optionD
                    },
                    correct: correctAnswer.value
                };

                console.log('‚úÖ Question object created:', question);

                // Add to batch
                batchQuestions.push(question);
                console.log('‚úÖ Added to batch. Total:', batchQuestions.length);
                
                // Update UI
                renderBatchQuestions();
                updateBatchCount();
                resetBatchForm();
                
                // Show success message
                showToast(`‚úì ƒê√£ th√™m c√¢u h·ªèi s·ªë ${batchQuestions.length}`, 'success');
                
                console.log('‚úÖ addQuestionToBatch completed successfully!');
            } catch (error) {
                console.error('‚ùå Error in addQuestionToBatch:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message + '\n\nVui l√≤ng m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.');
            }
        }

        // Render batch questions list
        function renderBatchQuestions() {
            const container = document.getElementById('batchQuestionsList');
            
            if (batchQuestions.length === 0) {
                container.innerHTML = '<div class="batch-empty">Ch∆∞a c√≥ c√¢u h·ªèi n√†o. ƒêi·ªÅn form b√™n d∆∞·ªõi ƒë·ªÉ th√™m c√¢u h·ªèi ƒë·∫ßu ti√™n.</div>';
                document.getElementById('batchSaveActions').style.display = 'none';
                return;
            }
            
            container.innerHTML = batchQuestions.map((q, index) => `
                <div class="batch-question-item" data-id="${q.id}">
                    <div class="batch-question-number">#${index + 1}</div>
                    <div class="batch-question-content">
                        <div class="batch-question-header">
                            <span class="batch-subject-badge">${q.subjectName}</span>
                            <button type="button" class="batch-remove-btn" onclick="removeBatchQuestion(${q.id})" title="X√≥a c√¢u h·ªèi n√†y">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="batch-question-title">${q.title}</div>
                        <div class="batch-question-options">
                            ${Object.entries(q.options).map(([key, value]) => `
                                <div class="batch-option ${key === q.correct ? 'batch-option-correct' : ''}">
                                    ${key}. ${value}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('batchSaveActions').style.display = 'flex';
        }

        // Remove question from batch
        function removeBatchQuestion(id) {
            if (confirm('X√≥a c√¢u h·ªèi n√†y kh·ªèi danh s√°ch?')) {
                batchQuestions = batchQuestions.filter(q => q.id !== id);
                renderBatchQuestions();
                updateBatchCount();
                showToast('ƒê√£ x√≥a c√¢u h·ªèi', 'info');
            }
        }

        // Update batch count
        function updateBatchCount() {
            const count = batchQuestions.length;
            document.getElementById('batchCount').textContent = count;
            document.getElementById('batchSaveCount').textContent = count;
            document.getElementById('currentBatchNumber').textContent = count + 1;
        }

        // Add new question to batch (scroll to form)
        function addNewQuestionToBatch() {
            document.getElementById('batchCurrentForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('batchQuestionContent').focus();
        }

        // Clear batch
        function clearBatch() {
            if (batchQuestions.length > 0) {
                if (!confirm(`X√≥a t·∫•t c·∫£ ${batchQuestions.length} c√¢u h·ªèi ƒë√£ th√™m?`)) {
                    return;
                }
            }
            batchQuestions = [];
            renderBatchQuestions();
            updateBatchCount();
            resetBatchForm();
        }

        // Save all batch questions
        function saveAllBatchQuestions() {
            if (batchQuestions.length === 0) {
                alert('Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ l∆∞u!');
                return;
            }

            if (!confirm(`L∆∞u ${batchQuestions.length} c√¢u h·ªèi v√†o ng√¢n h√†ng?`)) {
                return;
            }

            // In production: send to API
            console.log('Saving batch questions:', batchQuestions);

            // Simulate success
            alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ${batchQuestions.length} c√¢u h·ªèi!\n\nTrong production, d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn server.`);
            
            // Close modal and refresh
            closeAddQuestionModal();
            
            // In production: reload questions from server
            // loadQuestions();
        }

        // Toast notification helper
        function showToast(message, type = 'success') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#28a745' : '#17a2b8'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Question actions
        function viewQuestion(id) {
            alert('Xem chi ti·∫øt c√¢u h·ªèi #' + id + ' - T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn');
        }

        function editQuestion(id) {
            alert('Ch·ªânh s·ª≠a c√¢u h·ªèi #' + id + ' - T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn');
        }

        function deleteQuestion(id) {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi n√†y?')) {
                alert('X√≥a c√¢u h·ªèi #' + id + ' - T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn');
            }
        }

        // Close modal on outside click
        document.getElementById('addQuestionModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddQuestionModal();
            }
        });
    </script>

    <!-- Statistics Counter Animation -->
    <script src="~/js/teacher/question-bank.js"></script>
}
