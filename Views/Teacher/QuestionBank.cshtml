@model E_TestHub.Models.Question

@{
    ViewData["Title"] = "Ngân hàng câu hỏi";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var questions = ViewBag.Questions as List<E_TestHub.Models.Question> ?? new List<E_TestHub.Models.Question>();
    var subjects = ViewBag.Subjects as List<E_TestHub.Models.Subject> ?? new List<E_TestHub.Models.Subject>();
}

@section Styles {
    <link href="~/css/shared/dashboard.css" rel="stylesheet">
    <link href="~/css/teacher/question-bank.css" rel="stylesheet">
}

<!-- Hidden form for AJAX CSRF token -->
<form id="antiForgeryForm">
    @Html.AntiForgeryToken()
</form>

<!-- Welcome Section -->
<div class="dashboard-welcome-section">
    <h1 class="dashboard-welcome-title" style="font-weight: 700; color: #1a73e8;">Ngân hàng câu hỏi</h1>
    <p class="dashboard-welcome-subtitle">Quản lý và tổ chức kho câu hỏi trắc nghiệm</p>
</div>

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Action Cards -->
<div class="dashboard-action-cards">
    <a href="@Url.Action("CreateQuestion", "Teacher")" class="dashboard-action-card">
        <div class="dashboard-action-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <h3 class="dashboard-action-title">Thêm câu hỏi</h3>
        <p class="dashboard-action-subtitle">Tạo câu hỏi trắc nghiệm mới</p>
    </a>

    <a href="#" class="dashboard-action-card" onclick="openImportModal(); return false;">
        <div class="dashboard-action-icon">
            <i class="fas fa-file-import"></i>
        </div>
        <h3 class="dashboard-action-title">Import câu hỏi</h3>
        <p class="dashboard-action-subtitle">Nhập từ file Excel/Word/PDF</p>
    </a>

    <a href="#" class="dashboard-action-card" onclick="openExportModal(); return false;">
        <div class="dashboard-action-icon">
            <i class="fas fa-file-export"></i>
        </div>
        <h3 class="dashboard-action-title">Export câu hỏi</h3>
        <p class="dashboard-action-subtitle">Xuất ra file Excel/Word/PDF</p>
    </a>
</div>

<!-- Import Modal -->
<div id="importModal" class="import-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-import"></i> Import Câu Hỏi</h3>
            <button class="close-btn" onclick="closeImportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="file-upload-section">
                <label for="importFile" class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Chọn file để import</span>
                    <input type="file" id="importFile" accept=".xlsx,.docx,.pdf" onchange="updateFileName()" style="display: none;">
                </label>
                <p class="file-info">Hỗ trợ: .xlsx, .docx, .pdf (Tối đa 5MB)</p>
                <p id="selectedFileName" class="selected-file"></p>
            </div>
            <div class="template-section">
                <p><i class="fas fa-info-circle"></i> Chưa có file mẫu?</p>
                <div class="template-buttons">
                    <button class="btn-template" onclick="downloadTemplate('excel')">
                        <i class="fas fa-file-excel"></i> Tải mẫu Excel
                    </button>
                    <button class="btn-template btn-template-word" onclick="downloadTemplate('word')">
                        <i class="fas fa-file-word"></i> Tải mẫu Word
                    </button>
                    <button class="btn-template btn-template-pdf" onclick="downloadTemplate('pdf')">
                        <i class="fas fa-file-pdf"></i> Tải mẫu PDF
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeImportModal()">Hủy</button>
            <button class="btn-import" onclick="handleImport()">
                <i class="fas fa-file-import"></i> Import
            </button>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="import-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-export"></i> Export Câu Hỏi</h3>
            <button class="close-btn" onclick="closeExportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <div class="option-group">
                    <label><i class="fas fa-filter"></i> Lọc theo môn học:</label>
                    <select id="exportSubject" class="export-select">
                        <option value="">Tất cả môn học</option>
                        @foreach (var subject in subjects)
                        {
                            <option value="@subject.Code">@subject.Name</option>
                        }
                    </select>
                </div>
                <div class="option-group">
                    <label><i class="fas fa-file"></i> Chọn định dạng:</label>
                    <div class="format-buttons">
                        <button class="btn-format btn-excel active" data-format="excel" onclick="selectFormat('excel')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn-format btn-word" data-format="word" onclick="selectFormat('word')">
                            <i class="fas fa-file-word"></i> Word
                        </button>
                        <button class="btn-format btn-pdf" data-format="pdf" onclick="selectFormat('pdf')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeExportModal()">Hủy</button>
            <button class="btn-export" onclick="handleExport()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Content Sections -->
<div class="dashboard-content-sections">
    <!-- Statistics Section -->
    <div class="dashboard-section">
        <div class="dashboard-section-header">
            <h3 class="dashboard-section-title">
                <i class="fas fa-chart-bar" style="margin-right: 8px; color: #1a73e8;"></i>
                Thống kê tổng quan
            </h3>
        </div>

        <div class="stats-grid-modern">
            <!-- Total Questions -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-primary">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">@questions.Count</div>
                    <div class="stat-label-modern">Tổng câu hỏi</div>
                </div>
            </div>

            <!-- Total Subjects -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-success">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">@subjects.Count</div>
                    <div class="stat-label-modern">Môn học</div>
                </div>
            </div>

            <!-- Easy Questions -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-warning">
                    <i class="fas fa-smile"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">@questions.Count(q => q.DifficultyLevel == E_TestHub.Models.DifficultyLevel.Easy)</div>
                    <div class="stat-label-modern">Câu hỏi dễ</div>
                </div>
            </div>

            <!-- Hard Questions -->
            <div class="stat-card-modern">
                <div class="stat-icon-modern stat-danger">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="stat-info-modern">
                    <div class="stat-number-modern">@questions.Count(q => q.DifficultyLevel == E_TestHub.Models.DifficultyLevel.Hard)</div>
                    <div class="stat-label-modern">Câu hỏi khó</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions List Section -->
    <div class="dashboard-section">
        <div class="dashboard-section-header">
            <h3 class="dashboard-section-title">
                <i class="fas fa-list" style="margin-right: 8px; color: #1a73e8;"></i>
                Danh sách câu hỏi
            </h3>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="@Url.Action("QuestionBank", "Teacher")" class="row g-3">
                    <div class="col-md-4">
                        <label for="subjectFilter" class="form-label">Môn học</label>
                        <select id="subjectFilter" name="subjectId" class="form-select">
                            <option value="">-- Tất cả môn học --</option>
                            @foreach (var subject in subjects)
                            {
                                <option value="@subject.Id" selected="@(subject.Id == ViewBag.SelectedSubjectId)">
                                    @subject.Name
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="difficultyFilter" class="form-label">Độ khó</label>
                        <select id="difficultyFilter" name="difficulty" class="form-select">
                            <option value="">-- Tất cả độ khó --</option>
                            <option value="Easy" selected="@(ViewBag.SelectedDifficulty == "Easy")">Dễ</option>
                            <option value="Medium" selected="@(ViewBag.SelectedDifficulty == "Medium")">Trung bình</option>
                            <option value="Hard" selected="@(ViewBag.SelectedDifficulty == "Hard")">Khó</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="typeFilter" class="form-label">Loại câu hỏi</label>
                        <select id="typeFilter" name="type" class="form-select">
                            <option value="">-- Tất cả loại --</option>
                            <option value="MultipleChoice" selected="@(ViewBag.SelectedType == "MultipleChoice")">Trắc nghiệm</option>
                            <option value="Essay" selected="@(ViewBag.SelectedType == "Essay")">Tự luận</option>
                            <option value="TrueFalse" selected="@(ViewBag.SelectedType == "TrueFalse")">Đúng/Sai</option>
                        </select>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter"></i> Lọc
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Questions Table -->
        @if (questions.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 40%;">Nội dung câu hỏi</th>
                            <th style="width: 15%;">Môn học</th>
                            <th style="width: 10%;">Loại</th>
                            <th style="width: 10%;">Độ khó</th>
                            <th style="width: 8%;">Điểm</th>
                            <th style="width: 12%;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < questions.Count; i++)
                        {
                            var question = questions[i];
                            var difficultyClass = question.DifficultyLevel switch
                            {
                                E_TestHub.Models.DifficultyLevel.Easy => "badge bg-success",
                                E_TestHub.Models.DifficultyLevel.Medium => "badge bg-warning text-dark",
                                E_TestHub.Models.DifficultyLevel.Hard => "badge bg-danger",
                                _ => "badge bg-secondary"
                            };

                            var difficultyText = question.DifficultyLevel switch
                            {
                                E_TestHub.Models.DifficultyLevel.Easy => "Dễ",
                                E_TestHub.Models.DifficultyLevel.Medium => "Trung bình",
                                E_TestHub.Models.DifficultyLevel.Hard => "Khó",
                                _ => "N/A"
                            };

                            var typeText = question.Type switch
                            {
                                E_TestHub.Models.QuestionType.MultipleChoice => "Trắc nghiệm",
                                E_TestHub.Models.QuestionType.Essay => "Tự luận",
                                E_TestHub.Models.QuestionType.TrueFalse => "Đúng/Sai",
                                _ => "N/A"
                            };

                            <tr data-question-id="@question.ApiId">
                                <td>@(i + 1)</td>
                                <td>
                                    <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                         title="@question.Content">
                                        @question.Content
                                    </div>
                                </td>
                                <td>@(question.SubjectName ?? "N/A")</td>
                                <td>@typeText</td>
                                <td><span class="@difficultyClass">@difficultyText</span></td>
                                <td>@question.Score</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="@Url.Action("EditQuestion", "Teacher", new { id = question.ApiId })" 
                                           class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteQuestion('@question.ApiId')" title="Xóa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">Chưa có câu hỏi nào</h4>
                <p class="text-muted">Nhấn nút "Thêm câu hỏi" để bắt đầu tạo câu hỏi cho môn học này</p>
                <a href="@Url.Action("CreateQuestion", "Teacher")" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> Thêm câu hỏi đầu tiên
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        // Delete question function
        function deleteQuestion(questionId) {
            if (confirm('Bạn có chắc chắn muốn xóa câu hỏi này?')) {
                $.ajax({
                    url: '@Url.Action("DeleteQuestion", "Teacher")',
                    type: 'POST',
                    data: {
                        id: questionId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            // Remove row from table
                            $('tr[data-question-id="' + questionId + '"]').fadeOut(300, function() {
                                $(this).remove();
                                // Reload page to update statistics
                                location.reload();
                            });
                        } else {
                            alert('Lỗi: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Có lỗi xảy ra khi xóa câu hỏi.');
                    }
                });
            }
        }

        // Import Modal Functions
        function openImportModal() {
            $('#importModal').fadeIn(300);
        }

        function closeImportModal() {
            $('#importModal').fadeOut(300);
            $('#importFile').val('');
            $('#selectedFileName').text('');
        }

        function updateFileName() {
            const input = document.getElementById('importFile');
            const fileName = input.files[0]?.name || '';
            $('#selectedFileName').text(fileName);
        }

        function downloadTemplate(type) {
            if (type === 'excel') {
                window.location.href = '@Url.Action("DownloadQuestionTemplate", "Teacher")';
            } else if (type === 'word') {
                window.location.href = '@Url.Action("DownloadQuestionTemplateWord", "Teacher")';
            } else if (type === 'pdf') {
                window.location.href = '@Url.Action("DownloadQuestionTemplatePdf", "Teacher")';
            }
        }

        function handleImport() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files[0]) {
                alert('Vui lòng chọn file để import!');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            // Show loading
            $('#importModal .modal-content').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> Đang xử lý...</div>');

            $.ajax({
                url: '@Url.Action("ImportQuestions", "Teacher")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Redirect to preview page
                        window.location.href = response.redirectUrl;
                    } else {
                        alert('Lỗi: ' + response.message);
                        $('.loading-overlay').remove();
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra khi import file.');
                    $('.loading-overlay').remove();
                }
            });
        }

        // Export Modal Functions
        let selectedExportFormat = 'excel';

        function openExportModal() {
            $('#exportModal').fadeIn(300);
        }

        function closeExportModal() {
            $('#exportModal').fadeOut(300);
            selectedExportFormat = 'excel';
            $('.btn-format').removeClass('active');
            $('.btn-format[data-format="excel"]').addClass('active');
        }

        function selectFormat(format) {
            selectedExportFormat = format;
            $('.btn-format').removeClass('active');
            $('.btn-format[data-format="' + format + '"]').addClass('active');
        }

        function handleExport() {
            const subjectCode = $('#exportSubject').val();
            let url = '';

            if (selectedExportFormat === 'excel') {
                url = '@Url.Action("ExportQuestionsExcel", "Teacher")';
            } else if (selectedExportFormat === 'word') {
                url = '@Url.Action("ExportQuestionsWord", "Teacher")';
            } else if (selectedExportFormat === 'pdf') {
                url = '@Url.Action("ExportQuestionsPdf", "Teacher")';
            }

            if (subjectCode) {
                url += '?subjectCode=' + encodeURIComponent(subjectCode);
            }

            window.location.href = url;
            
            // Close modal after a short delay
            setTimeout(function() {
                closeExportModal();
            }, 500);
        }
    </script>
}
