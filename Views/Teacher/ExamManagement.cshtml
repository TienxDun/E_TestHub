@{
    ViewData["Title"] = "Quản lý đề thi";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var exams = ViewBag.Exams as List<E_TestHub.Models.Exam> ?? new List<E_TestHub.Models.Exam>();
    var subjects = ViewBag.Subjects as List<E_TestHub.Models.Subject> ?? new List<E_TestHub.Models.Subject>();
}

@section Styles {
    <link href="~/css/shared/dashboard.css" rel="stylesheet">
    <link href="~/css/teacher/question-bank.css" rel="stylesheet">
}

<!-- Hidden form for AJAX CSRF token -->
<form id="antiForgeryForm">
    @Html.AntiForgeryToken()
</form>

<!-- Welcome Section -->
<div class="dashboard-welcome-section">
    <h1 class="dashboard-welcome-title" style="font-weight: 700; color: #1a73e8;">Quản lý đề thi</h1>
    <p class="dashboard-welcome-subtitle">Tạo và quản lý các đề thi trắc nghiệm</p>
</div>

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Tổng số đề thi</h6>
                        <h2 class="card-title mb-0">@ViewBag.TotalExams</h2>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-file-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Bản nháp</h6>
                        <h2 class="card-title mb-0">@ViewBag.DraftExams</h2>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-edit fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Đã xuất bản</h6>
                        <h2 class="card-title mb-0">@ViewBag.PublishedExams</h2>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stats-card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Đã khóa</h6>
                        <h2 class="card-title mb-0">@ViewBag.LockedExams</h2>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-lock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Actions -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <form method="get" asp-action="ExamManagement" class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label">Môn học</label>
                        <select name="subjectId" class="form-select" onchange="this.form.submit()">
                            <option value="">Tất cả môn học</option>
                            @foreach (var subject in subjects)
                            {
                                <option value="@subject.Id" selected="@(ViewBag.SelectedSubject == subject.Id)">
                                    @subject.Name
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label">Trạng thái</label>
                        <select name="isPublished" class="form-select" onchange="this.form.submit()">
                            <option value="">Tất cả</option>
                            <option value="false" selected="@(ViewBag.SelectedIsPublished == false)">Bản nháp</option>
                            <option value="true" selected="@(ViewBag.SelectedIsPublished == true)">Đã xuất bản</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <a href="@Url.Action("ExamManagement")" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-redo"></i> Đặt lại
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-md-4 text-end">
                <a href="@Url.Action("CreateExam")" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tạo đề thi mới
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Exams Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list"></i> Danh sách đề thi
            <span class="badge bg-secondary ms-2">@exams.Count</span>
        </h5>
    </div>
    <div class="card-body">
        @if (exams.Count == 0)
        {
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Chưa có đề thi nào. Hãy tạo đề thi đầu tiên!</p>
                <a href="@Url.Action("CreateExam")" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tạo đề thi
                </a>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Tiêu đề</th>
                            <th>Môn học</th>
                            <th style="width: 100px;">Thời gian</th>
                            <th style="width: 100px;">Số câu hỏi</th>
                            <th style="width: 120px;">Trạng thái</th>
                            <th style="width: 180px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < exams.Count; i++)
                        {
                            var exam = exams[i];
                            var statusClass = exam.IsPublished ? "success" : "warning";
                            var statusText = exam.IsPublished ? "Đã xuất bản" : "Bản nháp";
                            var statusIcon = exam.IsPublished ? "check-circle" : "edit";

                            if (exam.IsLocked)
                            {
                                statusClass = "secondary";
                                statusText = "Đã khóa";
                                statusIcon = "lock";
                            }

                            <tr>
                                <td>@(i + 1)</td>
                                <td>
                                    <div style="max-width: 400px;">
                                        <strong>@exam.Title</strong>
                                        @if (!string.IsNullOrEmpty(exam.Description))
                                        {
                                            <br />
                                            <small class="text-muted">@exam.Description</small>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">@(exam.SubjectName ?? "N/A")</span>
                                </td>
                                <td>@exam.Duration phút</td>
                                <td class="text-center">
                                    <span class="badge bg-primary">@exam.QuestionCount</span>
                                </td>
                                <td>
                                    <span class="badge bg-@statusClass">
                                        <i class="fas fa-@statusIcon"></i> @statusText
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="@Url.Action("ExamBuilder", "Teacher", new { id = exam.ApiId })" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="Thêm câu hỏi">
                                            <i class="fas fa-puzzle-piece"></i>
                                        </a>
                                        <a href="@Url.Action("EditExam", "Teacher", new { id = exam.ApiId })" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        @if (exam.IsPublished)
                                        {
                                            <a href="@Url.Action("AssignExam", "Teacher", new { examId = exam.ApiId })" 
                                               class="btn btn-sm btn-outline-success" 
                                               title="Gán cho lớp">
                                                <i class="fas fa-calendar-plus"></i>
                                            </a>
                                        }
                                        
                                        @if (!exam.IsPublished)
                                        {
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-success" 
                                                    onclick="publishExam('@exam.ApiId', '@exam.Title')" 
                                                    title="Xuất bản">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        }

                                        @if (!exam.IsLocked)
                                        {
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteExam('@exam.ApiId', '@exam.Title')" 
                                                    title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Delete exam function with SweetAlert2
        function deleteExam(examId, examTitle) {
            Swal.fire({
                title: 'Xác nhận xóa đề thi',
                html: `Bạn có chắc chắn muốn xóa đề thi <strong>"${examTitle}"</strong>?<br><br>
                       <i class="fas fa-exclamation-triangle text-warning"></i> 
                       <strong>Lưu ý:</strong> Hành động này không thể hoàn tác!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash me-1"></i> Xóa',
                cancelButtonText: '<i class="fas fa-times me-1"></i> Hủy',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("DeleteExam", "Teacher")',
                        type: 'POST',
                        data: {
                            id: examId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        }
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message);
                        }
                        return response;
                    }).catch(error => {
                        Swal.showValidationMessage(`Lỗi: ${error.message || 'Có lỗi xảy ra khi xóa đề thi.'}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã xóa!',
                        text: result.value.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        }

        // Publish exam function with SweetAlert2
        function publishExam(examId, examTitle) {
            Swal.fire({
                title: 'Xuất bản đề thi',
                html: `Bạn có chắc chắn muốn xuất bản đề thi <strong>"${examTitle}"</strong>?<br><br>
                       <i class="fas fa-info-circle text-info"></i> 
                       Sau khi xuất bản, sinh viên sẽ có thể xem và làm bài thi này.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-paper-plane me-1"></i> Xuất bản',
                cancelButtonText: '<i class="fas fa-times me-1"></i> Hủy',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("PublishExam", "Teacher")',
                        type: 'POST',
                        data: {
                            id: examId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        }
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message);
                        }
                        return response;
                    }).catch(error => {
                        Swal.showValidationMessage(`Lỗi: ${error.message || 'Có lỗi xảy ra khi xuất bản đề thi.'}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã xuất bản!',
                        text: result.value.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        }

        // Show success/error messages from TempData with Toast
        $(document).ready(function() {
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                Toast.fire({
                    icon: 'success',
                    title: '@TempData["SuccessMessage"]'
                });
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 4000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'error',
                    title: '@TempData["ErrorMessage"]'
                });
                </text>
            }
        });
    </script>

    @Html.AntiForgeryToken()
}
